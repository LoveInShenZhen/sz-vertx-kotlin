# 证书格式

## 主流Web服务软件

一般来说，主流的Web服务软件，通常都基于OpenSSL和Java两种基础密码库。

* Tomcat、Weblogic、JBoss等Web服务软件，一般使用Java提供的密码库。通过Java Development Kit （JDK）工具包中的Keytool工具，生成Java Keystore（JKS）格式的证书文件。
* Apache、Nginx等Web服务软件，一般使用OpenSSL工具提供的密码库，生成PEM、KEY、CRT等格式的证书文件。
* IBM的Web服务产品，如Websphere、IBM Http Server（IHS）等，一般使用IBM产品自带的iKeyman工具，生成KDB格式的证书文件。
* 微软Windows Server中的Internet Information Services（IIS）服务，使用Windows自带的证书库生成PFX格式的证书文件。

## 如何判断证书文件是文本格式还是二进制格式？

* __*.DER__ 或 __*.CER__ 文件:这样的证书文件是二进制格式，只含有证书信息，不包含私钥。
* __*.CRT__ 文件：这样的证书文件可以是二进制格式，也可以是文本格式，一般均为文本格式，功能与 __*.DER__ 及 __*.CER__ 证书文件相同, 不保存私钥。
* __*.PEM__ 文件： 这样的证书文件一般是文本格式，可以存放证书或私钥，或者两者都包含。 __*.PEM__ 文件如果只包含私钥，一般用 __*.KEY__ 文件代替。
* __*.PFX__ 或 __*.P12__ 文件： 这样的证书文件是二进制格式，同时包含证书和私钥，且一般有密码保护。

## 查看证书

### DER

该格式是二进制文件内容，Java 和 Windows 服务器偏向于使用这种编码格式。

OpenSSL 查看

```bash
openssl x509 -in certificate.der -inform der -text -noout
```

转换为 PEM：

```bash
openssl x509 -in cert.crt -inform der -outform pem -out cert.pem
```

### PEM

Privacy Enhanced Mail，一般为文本格式，以 `-----BEGIN...` 开头，以 `-----END...` 结尾。中间的内容是 BASE64 编码。这种格式可以保存证书和私钥，有时我们也把PEM 格式的私钥的后缀改为 .key 以区别证书与私钥。具体你可以看文件的内容。

这种格式常用于 Apache 和 Nginx 服务器。

OpenSSL 查看：

```bash
openssl x509 -in certificate.pem -text -noout
```

转换为 DER：

```bash
openssl x509 -in cert.crt -outform der -out cert.der
```

### CRT

Certificate 的简称，有可能是 PEM 编码格式，也有可能是 DER 编码格式。如何查看请参考前两种格式。

### PFX

Predecessor of PKCS#12，这种格式是二进制格式，且证书和私钥存在一个 PFX 文件中。一般用于 Windows 上的 IIS 服务器。改格式的文件一般会有一个密码用于保证私钥的安全。

OpenSSL 查看：

```bash
openssl pkcs12 -in for-iis.pfx
```

转换为 PEM：

```bash
openssl pkcs12 -in for-iis.pfx -out for-iis.pem -nodes
```

### JKS

Java Key Storage，很容易知道这是 JAVA 的专属格式，利用 JAVA 的一个叫 `keytool` 的工具可以进行格式转换。一般用于 Tomcat 服务器。

## 证书格式转换

![img](http://help-static-aliyun-doc.aliyuncs.com/assets/img/13595/15513326674251_zh-CN.jpg)

* 将JKS格式证书转换成PFX格式

  您可以使用JDK中自带的Keytool工具，将JKS格式证书文件转换成PFX格式。例如，您可以执行以下命令将 server.jks证书文件转换成 server.pfx证书文件：

  ```bash
  keytool -importkeystore -srckeystore D:\server.jks -destkeystore D:\server.pfx
          -srcstoretype JKS -deststoretype PKCS12
  ```

* 将PFX格式证书转换为JKS格式

  您可以使用JDK中自带的Keytool工具，将PFX格式证书文件转换成JKS格式。例如，您可以执行以下命令将 server.pfx证书文件转换成 server.jks证书文件：

  ```bash
  keytool -importkeystore -srckeystore D:\server.pfx -destkeystore D:\server.jks
          -srcstoretype PKCS12 -deststoretype JKS
  ```

* 将PEM/KEY/CRT格式证书转换为PFX格式

  您可以使用 [OpenSSL工具](https://www.openssl.org/)，将KEY格式密钥文件和CRT格式公钥文件转换成PFX格式证书文件。例如，将您的KEY格式密钥文件（server.key）和CRT格式公钥文件（server.crt）拷贝至OpenSSL工具安装目录，使用OpenSSL工具执行以下命令将证书转换成 server.pfx证书文件：

  ```bash
  openssl pkcs12 -export -out server.pfx -inkey server.key -in server.crt
  ```

* 将PFX转换为PEM/KEY/CRT

  您可以使用 [OpenSSL工具](https://www.openssl.org/)，将PFX格式证书文件转化为KEY格式密钥文件和CRT格式公钥文件。例如，将您的PFX格式证书文件拷贝至OpenSSL安装目录，使用OpenSSL工具执行以下命令将证书转换成 __server.pem 证书文件__, __KEY格式密钥文件(server.key)__ 和 __CRT格式公钥文件(server.crt)__：

  ```bash
  openssl pkcs12 -in server.pfx -nodes -out server.pem
  openssl rsa -in server.pem -out server.key
  openssl x509 -in server.pem -out server.crt
  ```

  # Java keytool 基本指令

  ### keytool常用参数说明

  - -genkey 在用户主目录
  - -genkey 在用户主目录中创建一个默认文件”.keystore”,还会产生一个mykey的别名，mykey中包含用户的公钥、私钥和证书(在没有指定生成位置的情况下,keystore会存在用户系统默认目录)
  - -alias 产生别名 每个keystore都关联这一个独一无二的alias，这个alias通常不区分大小写
  - -keystore 指定密钥库的名称(产生的各类信息将不在.keystore文件中)
  - -keyalg 指定密钥的算法 (如 RSA DSA，默认值为：DSA)
  - -validity 指定创建的证书有效期多少天(默认 90)
  - -keysize 指定密钥长度 （默认 1024）
  - -storepass 指定密钥库的密码(获取keystore信息所需的密码)
  - -keypass 指定别名条目的密码(私钥的密码)
  - -dname 指定证书发行者信息 其中： “CN=名字与姓氏,OU=组织单位名称,O=组织名称,L=城市或区域名 称,ST=州或省份名称,C=单位的两字母国家代码”
  - -list 显示密钥库中的证书信息 keytool -list -v -keystore 指定keystore -storepass 密码
  - -v 显示密钥库中的证书详细信息
  - -export 将别名指定的证书导出到文件 keytool -export -alias 需要导出的别名 -keystore 指定keystore -file 指定导出的证书位置及证书名称 -storepass 密码
  - -file 参数指定导出到文件的文件名
  - -delete 删除密钥库中某条目 keytool -delete -alias 指定需删除的别 -keystore 指定keystore – storepass 密码
  - -printcert 查看导出的证书信息 keytool -printcert -file g:\sso\michael.crt
  - -keypasswd 修改密钥库中指定条目口令 keytool -keypasswd -alias 需修改的别名 -keypass 旧密码 -new 新密码 -storepass keystore密码 -keystore sage
  - -storepasswd 修改keystore口令 keytool -storepasswd -keystore g:\sso\michael.keystore(需修改口令的keystore) -storepass pwdold(原始密码) -new pwdnew(新密码)
  - -import 将已签名数字证书导入密钥库 keytool -import -alias 指定导入条目的别名 -keystore 指定keystore -file 需导入的证书
  - 中创建一个默认文件”.keystore”,还会产生一个mykey的别名，mykey中包含用户的公钥、私钥和证书(在没有指定生成位置的情况下,keystore会存在用户系统默认目录)
  - -alias 产生别名 每个keystore都关联这一个独一无二的alias，这个alias通常不区分大小写
  - -keystore 指定密钥库的名称(产生的各类信息将不在.keystore文件中)
  - -keyalg 指定密钥的算法 (如 RSA DSA，默认值为：DSA)
  - -validity 指定创建的证书有效期多少天(默认 90)
  - -keysize 指定密钥长度 （默认 1024）
  - -storepass 指定密钥库的密码(获取keystore信息所需的密码)
  - -keypass 指定别名条目的密码(私钥的密码)
  - -dname 指定证书发行者信息 其中： “CN=名字与姓氏,OU=组织单位名称,O=组织名称,L=城市或区域名 称,ST=州或省份名称,C=单位的两字母国家代码”
  - -list 显示密钥库中的证书信息 keytool -list -v -keystore 指定keystore -storepass 密码
  - -v 显示密钥库中的证书详细信息
  - -export 将别名指定的证书导出到文件 keytool -export -alias 需要导出的别名 -keystore 指定keystore -file 指定导出的证书位置及证书名称 -storepass 密码
  - -file 参数指定导出到文件的文件名
  - -delete 删除密钥库中某条目 keytool -delete -alias 指定需删除的别 -keystore 指定keystore – storepass 密码
  - -printcert 查看导出的证书信息 keytool -printcert -file g:\sso\michael.crt
  - -keypasswd 修改密钥库中指定条目口令 keytool -keypasswd -alias 需修改的别名 -keypass 旧密码 -new 新密码 -storepass keystore密码 -keystore sage
  - -storepasswd 修改keystore口令 keytool -storepasswd -keystore g:\sso\michael.keystore(需修改口令的keystore) -storepass pwdold(原始密码) -new pwdnew(新密码)
  - -import 将已签名数字证书导入密钥库 keytool -import -alias 指定导入条目的别名 -keystore 指定keystore -file 需导入的证书

  ### Keytool创建和导入命令
  * 创建keystore和密钥对

  ```bash
  keytool -genkey -alias mydomain -keyalg RSA -keystore keystore.jks -keysize 2048
  ```

  * 为存在的keystore生成证书请求文件CSR
  
  ```bash
  keytool -certreq -alias mydomain -keystore keystore.jks -file mydomain.csr
  ```
  
  * 导入根证书或中级证书到keystore
  
  ```bash
  keytool -import -trustcacerts -alias root -file mydomain.crt -keystore keystore.jks
  ```
  
  * 导入SSL服务器证书到keystore
  
  ```bash
  keytool -import -trustcacerts -alias mydomain -file mydomain.crt -keystore keystore.jks
  ```
  
  * 为存在的keystore生成自签名证书
  
  ```bash
  keytool -genkey -keyalg RSA -alias selfsigned -keystore keystore.jks -storepass password -validity 360 -keysize 2048
  ```
  
  ### Keytool查看命令
  
  * 查看单个证书
  
  ```bash
  keytool -printcert -v -file mydomain.crt
  ```
  
  * 列出keystore存在的所有证书
  
  ```bash
  keytool -list -v -keystore keystore.jks
  ```
  
  * 使用别名查看keystore特定条目
  
  ```bash
  keytool -list -v -keystore keystore.jks -alias mydomain
  ```
  
  ### 其他Keytool命令
  
  * 删除keystore里面指定证书
  
  ```bash
  keytool -delete -alias mydomain -keystore keystore.jks
  ```
  
  * 更改keysore密码
  
  ```bash
  keytool -storepasswd -new new_storepass -keystore keystore.jks
  ```
  
  * 导出keystore里面的指定证书
  
  ```bash
  keytool -export -alias mydomain -file mydomain.crt -keystore keystore.jks
  ```
  
  * 列出信任的CA证书
  
  ```bash
  keytool -list -v -keystore $JAVA_HOME/jre/lib/security/cacerts
  ```
  
  * 导入新的CA到信任证书
  
  ```bash
  keytool -import -trustcacerts -file /path/to/ca/ca.pem -alias CA_ALIAS -keystore $JAVA_HOME/jre/lib/security/cacerts
  ```
  
  